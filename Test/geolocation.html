<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
</head>

<body>

  <h1>Distanze dal punto in cui mi trovo</h1>

  <h3 id="demo"></h3>

  <br>
  <div id="mapholder"></div>
  <br>

  <p>Clicca il bottone per ottenere le tue coordinate e verificare le distanze da alcune citt&agrave;. </p>

  <button onclick="getLocation()">Click!</button>

  <br>
  <p class="distances"></p>
  <p class="distances"></p>
  <p class="distances"></p>
  <p class="distances"></p>
  <br>

  <p>Clicca il bottone per riordinare le localit&agrave; a te pi&ugrave; vicine.</p>

  <button onclick="SortPlaces()">Click!</button>

  <br>
  <p class="ordered"></p>
  <p class="ordered"></p>
  <p class="ordered"></p>
  <p class="ordered"></p>
  <br>

<script>

var mylat;
var mylon;

var arr = document.querySelectorAll(".distances");
var arr2 = document.querySelectorAll(".ordered");
var x = document.getElementById("demo");

var località = {
  "Jesolo"  : {"name": "Jesolo", "lat": 45.5063264, "lon": 12.64573889999997},
  "Treviso" : {"name": "Treviso","lat": 45.6668893,"lon": 12.243043700000044},
  "Vicenza" : {"name": "Vicenza","lat": 45.5454787,"lon": 11.535421400000018},
  "Londra"  : {"name": "Londra", "lat": 51.5073509, "lon": -0.12775829999998223}
};

function CalcolaDistanza(mylat,mylon,lat,lon){

    Number.prototype.toRad = function() {
       return this * Math.PI / 180;
    }

    var R = 6371; // km
    var x1 = mylat-lat;
    var dLat = x1.toRad();
    var x2 = mylon-lon;
    var dLon = x2.toRad();
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat.toRad()) * Math.cos(mylat.toRad()) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    var d = R * c;

    return d;
}

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(showPosition);
    } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}

function showPosition(position) {
    x.innerHTML="La mia Latitudine: " + position.coords.latitude +
    "<br>La mia Longitudine: " + position.coords.longitude;

    var latlon = position.coords.latitude + "," + position.coords.longitude;

    var img_url = "http://maps.googleapis.com/maps/api/staticmap?center="
    +latlon+"&zoom=14&size=400x300&sensor=false";
    document.getElementById("mapholder").innerHTML = "<img src='"+img_url+"'>";

    mylat = position.coords.latitude;
    mylon = position.coords.longitude;

    //Scorro tutte le località, calcolando la distanza dalla posizione attuale e inserendo
    //una nuova proprietà "distance" all'array delle località

    _.each(località,function(località){
      return  località.distance = CalcolaDistanza(mylat,mylon,località.lat,località.lon);
    });

    var j=0;

    _.each(località,function(località){

      return  arr[j++].innerHTML = località.name + " : " + località.distance + " Km";

    });
}

function SortPlaces(){
    var sortedlist = _.sortBy(località,function(località){return Math.floor(località.distance)})

    var k=0;

    _.each(sortedlist,function(sortedlist){
      return  arr2[k++].innerHTML = sortedlist.name + " : " + sortedlist.distance + " Km";
    });
}

</script>

</body>
</html>
